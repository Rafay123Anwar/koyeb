{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
    <title>Certificate Designer</title>

    <!-- Custom Font -->
    <style>
        @font-face {
            font-family: 'MonteCarlo';
            src: url("{% static 'fonts/MonteCarlo-Regular.ttf' %}") format('truetype');
        }
        
        body {
            background-color: #f8f9fa;
            font-family: 'Arial', sans-serif;
        }
        canvas {
            background-color: #fff;
            display: block;
            margin: auto;
            border: 2px solid #ddd;
            max-width: 100%;
            height: auto; /* Ensures canvas scales proportionally */
        }
    </style>
</head>
<body>
<div class="container my-5">
    <div class="row">
        <!-- Header -->
        <div class="col-12 text-center mb-4">
            <h1 class="display-5">Certificate Designer</h1>
            <p class="text-muted">Easily customize the text, position, and styling of your certificate in real time.</p>
        </div>

        <!-- Main Content -->
        <div class="col-md-8">
            <div class="card shadow">
                <div class="card-header bg-primary text-white text-center">
                    <h4>Certificate Preview</h4>
                </div>
                <div class="card-body">
                    <canvas id="certificateCanvas"></canvas>
                </div>
            </div>
        </div>

        <div class="col-md-4">
            <div class="card shadow">
                <div class="card-header bg-dark text-white">
                    <h5>Customization Options</h5>
                </div>
                <div class="card-body">
                    <form method="post">
                        {% csrf_token %}
                        <!-- Name -->
                        <div class="mb-3">
                            <label for="textInput" class="form-label">Name:</label>
                            <input type="text" id="textInput" name="text" class="form-control" value="Name">
                        </div>

                        <!-- Position -->
                        <div class="mb-3">
                            <label for="x" class="form-label">X Coordinate:</label>
                            <input type="number" id="x" name="x" class="form-control" value="400">
                        </div>
                        <div class="mb-3">
                            <label for="y" class="form-label">Y Coordinate:</label>
                            <input type="number" id="y" name="y" class="form-control" value="300">
                        </div>

                        <!-- Font Customization -->
                        <div class="mb-3">
                            <label for="fontSize" class="form-label">Font Size:</label>
                            <input type="number" id="fontSize" name="fontSize" class="form-control" value="20">
                        </div>
                        <div class="mb-3">
                            <label for="fontColor" class="form-label">Font Color:</label>
                            <input type="color" id="fontColor" name="fontColor" class="form-control" value="#000000">
                        </div>

                        <!-- Submit -->
                        <button type="submit" class="btn btn-primary w-100">Submit Changes</button>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- JS Section -->
<script>
    const canvas = document.getElementById('certificateCanvas');
    const ctx = canvas.getContext('2d');
    const inputX = document.getElementById('x');
    const inputY = document.getElementById('y');
    const fontSizeInput = document.getElementById('fontSize');
    const fontColorInput = document.getElementById('fontColor');
    const textInput = document.getElementById('textInput');
    
    let nameText = "Name"; // Default text
    let namePosition = { x: 400, y: 300 }; // Default coordinates
    let fontSize = 20;
    let fontColor = "#000000";
    
    let isDragging = false; // Track drag status
    let offset = { x: 0, y: 0 }; // Offset for dragging
    
    {% if certificate_image_data %}
    const certificateImage = new Image();
    certificateImage.src = "data:image/png;base64,{{ certificate_image_data }}";
    certificateImage.onload = () => adjustCanvasSize();
    {% endif %}
    
    const originalWidth = 800;
    const originalHeight = 600;
    
    function adjustCanvasSize() {
        const containerWidth = canvas.parentElement.offsetWidth;
    
        canvas.width = containerWidth;
        canvas.height = (containerWidth * originalHeight) / originalWidth;
    
        drawCanvas();
    }
    
    function drawCanvas() {
        ctx.clearRect(0, 0, canvas.width, canvas.height);
    
        const scaleRatio = canvas.width / originalWidth;
    
        ctx.drawImage(certificateImage, 0, 0, canvas.width, canvas.height);
    
        ctx.font = `${fontSize * scaleRatio}px MonteCarlo`;
        ctx.fillStyle = fontColor;
    
        ctx.fillText(
            nameText,
            namePosition.x * scaleRatio,
            namePosition.y * scaleRatio
        );
    }
    
    // Drag-and-Drop Logic
    canvas.addEventListener('mousedown', (e) => {
        const scaleRatio = canvas.width / originalWidth;
    
        const mouseX = e.offsetX / scaleRatio;
        const mouseY = e.offsetY / scaleRatio;
    
        const textWidth = ctx.measureText(nameText).width;
        const textHeight = fontSize;
    
        if (
            mouseX >= namePosition.x &&
            mouseX <= namePosition.x + textWidth &&
            mouseY >= namePosition.y - textHeight &&
            mouseY <= namePosition.y
        ) {
            isDragging = true;
            offset.x = mouseX - namePosition.x;
            offset.y = mouseY - namePosition.y;
        }
    });
    
    canvas.addEventListener('mousemove', (e) => {
        if (isDragging) {
            const scaleRatio = canvas.width / originalWidth;
    
            const mouseX = e.offsetX / scaleRatio;
            const mouseY = e.offsetY / scaleRatio;
    
            namePosition.x = mouseX - offset.x;
            namePosition.y = mouseY - offset.y;
    
            inputX.value = Math.round(namePosition.x);
            inputY.value = Math.round(namePosition.y);
    
            drawCanvas();
        }
    });
    
    canvas.addEventListener('mouseup', () => {
        isDragging = false;
    });
    
    // Input Listeners
    inputX.addEventListener('input', () => {
        namePosition.x = parseInt(inputX.value, 10) || 0;
        drawCanvas();
    });
    inputY.addEventListener('input', () => {
        namePosition.y = parseInt(inputY.value, 10) || 0;
        drawCanvas();
    });
    fontSizeInput.addEventListener('input', () => {
        fontSize = parseInt(fontSizeInput.value, 10) || 20;
        drawCanvas();
    });
    fontColorInput.addEventListener('input', () => {
        fontColor = fontColorInput.value;
        drawCanvas();
    });
    textInput.addEventListener('input', () => {
        nameText = textInput.value || "Name";
        drawCanvas();
    });
    
    // Responsive resizing
    window.addEventListener('resize', adjustCanvasSize);
    
    adjustCanvasSize();
     
</script>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
